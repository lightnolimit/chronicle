# x402 Integration

## What is x402?

x402 is a payment protocol that enables micropayments over HTTP using USDC on Base.

## How It Works

1. Client signs a payment authorization
2. Authorization included in `X-Payment` header
3. Server validates on-chain
4. Payment settles after service delivery

## Implementation

### Server-Side Middleware

```typescript
import { x402Middleware } from '@chronicle/x402';

app.use(x402Middleware({
  requiredAmount: 0.01, // Minimum $0.01
  recipient: CHRONICLE_ADDRESS,
  network: 'base',
}));
```

### Client-Side Payment

```typescript
import { createPaymentHeader } from '@chronicle/x402-client';

const payment = await createPaymentHeader({
  privateKey: userPrivateKey,
  amount: '0.01',
  recipient: CHRONICLE_ADDRESS,
  nonce: Date.now(),
});

fetch('/upload/markdown', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Payment': payment,
  },
  body: JSON.stringify({ data }),
});
```

## Payment Validation

### Steps

1. Decode base64 payment header
2. Verify signature matches wallet
3. Check amount >= minimum
4. Verify nonce hasn't been used
5. Verify recipient is correct

### Code

```typescript
async function validatePayment(header: string): Promise<boolean> {
  const decoded = Buffer.from(header, 'base64').toString();
  const { signature, amount, recipient, nonce, wallet } = JSON.parse(decoded);
  
  // Verify signature
  const recovered = ethers.verifyMessage(
    JSON.stringify({ amount, recipient, nonce }),
    signature
  );
  
  if (recovered.toLowerCase() !== wallet.toLowerCase()) {
    throw new Error('Invalid signature');
  }
  
  // Check amount
  if (parseFloat(amount) < 0.01) {
    throw new Error('Insufficient payment');
  }
  
  // Check recipient
  if (recipient.toLowerCase() !== CHRONICLE_ADDRESS.toLowerCase()) {
    throw new Error('Wrong recipient');
  }
  
  return true;
}
```

## Turbo x402

Turbo natively supports x402 payments:

```typescript
const response = await fetch(TURBO_UPLOAD_URL, {
  method: 'POST',
  body: data,
  headers: {
    'Content-Type': contentType,
    'x402': 'true',
  },
});
```

The payment flows through CHRONICLE's wallet to Turbo automatically.

## Rate Limits

- 100 requests per minute per wallet
- 10MB max upload size
- Configurable per deployment

## Error Codes

| Code | Description |
|------|-------------|
| `PAYMENT_REQUIRED` | Missing payment header |
| `INVALID_SIGNATURE` | Signature verification failed |
| `INSUFFICIENT_AMOUNT` | Payment below minimum |
| `WRONG_RECIPIENT` | Payment to wrong address |
| `NONCE_USED` | Replay attack detected |
