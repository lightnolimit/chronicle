# x402 Integration

Chronicle uses PayAI as the x402 facilitator. The server is configured in `agent/src/server.ts`.

## Server Setup

Key points:

- `payment-required` and `payment-response` headers must be exposed via CORS
- `PAYMENT-SIGNATURE` is required on the paid retry
- Network is CAIP-2 format: `eip155:8453` (Base) or `eip155:84532` (Base Sepolia)

Upload pricing for `/api/upload` is dynamic and sourced from `agent/src/services/pricing.ts` (Turbo price + 10% markup, min $0.01). AI endpoints remain fixed prices defined in `agent/src/server.ts`.

## Client Flow (Frontend)

1. Make the request without payment.
2. Read `payment-required` header on 402.
3. Build EIP-712 `TransferWithAuthorization` typed data.
4. Sign with `signTypedData` (not `signMessage`).
5. Retry with `PAYMENT-SIGNATURE` header containing base64 JSON payload.

The frontend implementation lives in `frontend/src/App.tsx` and `frontend/src/utils/payment.ts`.
